#!/usr/sbin/nft -f

flush ruleset

# Define network segments
define VLAN_MGMT = <IP_NETWORK>
define VLAN_SRV = <IP_NETWORK>
define VLAN_CLIENT = <IP_NETWORK>
define VLAN_IOT = <IP_NETWORK>
define UPSTREAM = <IP_NETWORK>

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback
        iif "lo" accept

        # Allow established/related connections
        ct state established,related accept

        # === SSH ACCESS (Port 22) ===
        # Only from MGMT VLAN and Admin PC
        iif "eth0.10" ip saddr $VLAN_MGMT tcp dport 22 accept

        # === WEB UI ACCESS (Monitoring Tools) ===
        # Uptime Kuma (3001), Grafana (3000), Prometheus (9090)
        # Only from MGMT VLAN and Admin PC
        iif "eth0.10" ip saddr $VLAN_MGMT tcp dport { 80, 443, 3000, 3001, 3100, 3200, 9090 } accept
        # === ALLOW WEB TRAFFIC ON ETH0 (From AT&T Gateway) ===
        iif "eth0" tcp dport { 80, 443 } accept comment "Allow HTTP/HTTPS from internet"


        # === DHCP SERVICE (Port 67) ===
        # All VLANs need DHCP
        iif "eth0.10" udp dport 67 accept
        iif "eth0.20" udp dport 67 accept
        iif "eth0.30" udp dport 67 accept
        iif "eth0.40" udp dport 67 accept

        # === DNS SERVICE (Port 53) ===
        # All VLANs need DNS
        iif "eth0.10" udp dport 53 accept
        iif "eth0.20" udp dport 53 accept
        iif "eth0.30" udp dport 53 accept
        iif "eth0.40" udp dport 53 accept

        # === ICMP (Ping) ===
        # Allow from MGMT, Admin PC, and all VLANs (for diagnostics)
        iif "eth0.10" ip saddr $VLAN_MGMT icmp type echo-request accept
        iif "eth0.20" ip saddr $VLAN_SRV icmp type echo-request accept
        iif "eth0.30" ip saddr $VLAN_CLIENT icmp type echo-request accept
        iif "eth0.40" ip saddr $VLAN_IOT icmp type echo-request accept
        iif "eth0" ip saddr $UPSTREAM icmp type echo-request accept

        # === LOG DROPPED INPUT ===
        log prefix "INPUT-DROP: " limit rate 5/minute
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Allow established/related connections
        ct state established,related accept

        # === MGMT VLAN RULES === OLD
        # MGMT can reach:
        # - All VLAN gateways (for management)
        # - Internet (for updates)
        #iif eth0.10 ip saddr VLAN_MGMT ip daddr { <IP_ADDR>, <IP_ADDR>, <IP_ADDR>, <IP_ADDR> } accept
        #iif eth0.10 ip saddr VLAN_MGMT oif eth0 accept

        # === MGMT VLAN RULES === NEW
        # MGMT has full access to all VLANs and internet
        iif "eth0.10" ip saddr $VLAN_MGMT accept


        # Allow Nginx (MGMT) to proxy to portfolio app (SRV VLAN)
        iif "eth0.10" oif "eth0.20" ip saddr <IP_ADDR> ip daddr <IP_ADDR> tcp dport 3200 ct state new,established accept comment "Nginx → Portfolio (SRV)"
        iif "eth0.20" oif "eth0.10" ip saddr <IP_ADDR> ip daddr <IP_ADDR> tcp sport 3200 ct state established accept comment "Portfolio → Nginx (return)"

        # === SRV VLAN RULES ===
        # SRV can reach:
        # - Internet only (for website hosting)
        iif "eth0.20" ip saddr $VLAN_SRV oif "eth0" accept

        # === CLIENT VLAN RULES ===
        # CLIENT can reach:
        # - Internet only
        iif "eth0.30" ip saddr $VLAN_CLIENT oif "eth0" accept

        # === IOT VLAN RULES ===
        # IoT can reach:
        # - Internet (for cloud services)
        # - Upstream WiFi devices (so Home Assistant can control them)
        iif "eth0.40" ip saddr $VLAN_IOT oif "eth0" accept
        iif "eth0.40" ip saddr $VLAN_IOT ip daddr $UPSTREAM accept

        # === LOG DROPPED FORWARD ===
        log prefix "FORWARD-DROP: " limit rate 5/minute
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

# NAT table (unchanged)
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # Masquerade all VLAN traffic going to internet
        ip saddr $VLAN_MGMT oif "eth0" masquerade
        ip saddr $VLAN_SRV oif "eth0" masquerade
        ip saddr $VLAN_CLIENT oif "eth0" masquerade
        ip saddr $VLAN_IOT oif "eth0" masquerade
    }
}